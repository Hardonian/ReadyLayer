name: Database Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (relative to backend/prisma/migrations/)'
        required: false
        type: string
      verify_only:
        description: 'Only verify migration (do not run)'
        required: false
        default: 'false'
        type: boolean
      archive_after:
        description: 'Archive migration after successful completion'
        required: false
        default: 'true'
        type: boolean

jobs:
  migrate:
    name: Run Database Migration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: List available migrations
        id: list_migrations
        run: |
          echo "Available migrations:"
          ls -la backend/prisma/migrations/ || echo "No migrations found"
          echo "migrations<<EOF" >> $GITHUB_OUTPUT
          ls -1 backend/prisma/migrations/ 2>/dev/null | grep -v "^archived" || echo "none" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Determine migration to run
        id: determine_migration
        run: |
          if [ -n "${{ github.event.inputs.migration_file }}" ]; then
            MIGRATION="${{ github.event.inputs.migration_file }}"
          else
            # Find latest non-archived migration
            MIGRATION=$(ls -1t backend/prisma/migrations/ 2>/dev/null | grep -v "^archived" | head -1)
          fi
          
          if [ -z "$MIGRATION" ] || [ "$MIGRATION" = "none" ]; then
            echo "No migration found"
            exit 1
          fi
          
          echo "migration=$MIGRATION" >> $GITHUB_OUTPUT
          echo "migration_path=backend/prisma/migrations/$MIGRATION" >> $GITHUB_OUTPUT
          echo "Running migration: $MIGRATION"

      - name: Run Migration
        if: github.event.inputs.verify_only != 'true'
        run: |
          MIGRATION_PATH="${{ steps.determine_migration.outputs.migration_path }}"
          echo "Executing migration from: $MIGRATION_PATH"
          
          if [ ! -f "$MIGRATION_PATH/migration.sql" ]; then
            echo "Error: migration.sql not found in $MIGRATION_PATH"
            exit 1
          fi
          
          # Run migration using Prisma
          npx tsx scripts/run-migration-from-file.ts "$MIGRATION_PATH/migration.sql"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production

      - name: Verify Migration
        run: |
          npm run migrate:verify
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production

      - name: Test Tenant Isolation
        run: |
          npm run test:tenant-isolation
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
        continue-on-error: true

      - name: Test Billing Enforcement
        run: |
          npm run test:billing
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NODE_ENV: production
        continue-on-error: true

      - name: Archive Migration
        if: github.event.inputs.archive_after != 'false' && github.event.inputs.verify_only != 'true'
        run: |
          MIGRATION="${{ steps.determine_migration.outputs.migration }}"
          MIGRATION_PATH="${{ steps.determine_migration.outputs.migration_path }}"
          
          # Create archived directory if it doesn't exist
          mkdir -p backend/prisma/migrations/archived
          
          # Move migration to archived
          mv "$MIGRATION_PATH" "backend/prisma/migrations/archived/$MIGRATION"
          
          echo "Migration archived to: backend/prisma/migrations/archived/$MIGRATION"
          
          # Commit and push archived migration
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add backend/prisma/migrations/archived/
          git add backend/prisma/migrations/
          git commit -m "chore: archive migration $MIGRATION after successful execution" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }} || echo "Push failed (may need manual push)"

      - name: Migration Summary
        if: always()
        run: |
          echo "## Migration Results" >> $GITHUB_STEP_SUMMARY
          echo "- Migration: ${{ steps.determine_migration.outputs.migration }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Archived: ${{ github.event.inputs.archive_after }}" >> $GITHUB_STEP_SUMMARY
